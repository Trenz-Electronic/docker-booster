#!/bin/sh
# Test runner for docker-booster
# Usage: run [--no-cleanup] [--cleanup | --all | <test-prefix>...]

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
CLEANUP=1
RUN_TESTS=1
TEST_PATTERNS=""

# Parse arguments
while [ $# -gt 0 ]; do
    case "$1" in
        --no-cleanup) CLEANUP=0 ;;
        --cleanup)    RUN_TESTS=0 ;;
        --all)        TEST_PATTERNS="--all" ;;
        -*)           echo "Usage: $0 [--no-cleanup] [--cleanup | --all | <test-prefix>...]" >&2; exit 1 ;;
        *)            TEST_PATTERNS="$TEST_PATTERNS $1" ;;
    esac
    shift
done

# Default to requiring explicit test selection
if [ "$RUN_TESTS" = 1 ] && [ -z "$TEST_PATTERNS" ]; then
    echo "Usage: $0 [--no-cleanup] [--cleanup | --all | <test-prefix>...]" >&2
    exit 1
fi

cleanup() {
    echo "Cleaning up test containers and images..."
    for dir in "$SCRIPT_DIR"/*/; do
        [ -d "$dir" ] || continue
        name=$(basename "$dir")
        docker rm -f "$name" 2>/dev/null || true
        docker rmi -f "$name" 2>/dev/null || true
    done
}

find_test_dir() {
    prefix="$1"
    matches=$(find "$SCRIPT_DIR" -maxdepth 1 -type d -name "${prefix}*" 2>/dev/null | grep -v "^${SCRIPT_DIR}$" || true)
    count=$(echo "$matches" | grep -c . || true)

    if [ "$count" -eq 0 ] || [ -z "$matches" ]; then
        echo "Error: No test matching '$prefix'" >&2
        return 1
    elif [ "$count" -gt 1 ]; then
        echo "Error: Multiple tests match '$prefix':" >&2
        echo "$matches" | xargs -n1 basename >&2
        return 1
    fi
    echo "$matches"
}

run_tests() {
    passed=0
    failed=0
    failed_tests=""

    # Build list of test directories
    test_dirs=""
    if [ "$TEST_PATTERNS" = "--all" ]; then
        for dir in "$SCRIPT_DIR"/*/; do
            [ -d "$dir" ] && [ -f "$dir/test.sh" ] && test_dirs="$test_dirs $dir"
        done
    else
        for pattern in $TEST_PATTERNS; do
            dir=$(find_test_dir "$pattern") || exit 1
            if [ ! -f "$dir/test.sh" ]; then
                echo "Error: No test.sh in $dir" >&2
                exit 1
            fi
            test_dirs="$test_dirs $dir"
        done
    fi

    for dir in $test_dirs; do
        name=$(basename "$dir")
        printf "Running %s... " "$name"

        if (cd "$dir" && sh test.sh) > /tmp/test-output-$$ 2>&1; then
            echo "PASS"
            passed=$((passed + 1))
        else
            echo "FAIL"
            failed=$((failed + 1))
            failed_tests="$failed_tests $name"
            cat /tmp/test-output-$$
        fi
        rm -f /tmp/test-output-$$
    done

    echo ""
    echo "Results: $passed passed, $failed failed"

    if [ -n "$failed_tests" ]; then
        echo "Failed:$failed_tests"
        return 1
    fi
}

# Execute
if [ "$RUN_TESTS" = 1 ]; then
    run_tests
    test_result=$?
else
    test_result=0
fi

if [ "$CLEANUP" = 1 ]; then
    cleanup
fi

exit $test_result
